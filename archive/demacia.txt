To be rewritten when I have more time.